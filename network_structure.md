# UDTATIS网络结构详细说明

## 系统概览

UDTATIS（无监督视差容忍太赫兹图像拼接算法）是一个两阶段深度学习系统，包含Warp（几何对齐）和Composition（图像融合）两个主要模块。下面详细描述各模块的网络结构。

## 1. Warp阶段网络结构

Warp阶段负责实现输入图像对的几何对齐，包含以下关键组件：

### 1.1 特征提取模块

- **骨干网络**: EfficientNet-B3
- **输入**: 两张待对齐的图像 (H×W×3)
- **输出**: 5个不同尺度的特征图，对应原始图像的1/4、1/8、1/16、1/32和1/64尺寸
- **结构**:
  - EfficientNet-B3基础骨干网络
  - 特征金字塔网络(FPN)用于多尺度特征融合
  - 5个输出特征层，通道数依次为: 64, 128, 256, 512, 1024

```
输入图像 → EfficientNet-B3 → 多尺度特征 → FPN → 5级特征图
```

### 1.2 特征匹配模块

- **架构**: 基于Transformer的特征匹配网络
- **输入**: 两组多尺度特征图
- **输出**: 特征匹配矩阵和匹配点对
- **子模块**:
  - **特征投影**: 使用1×1卷积将特征维度统一为256
  - **自注意力层**: 增强特征的全局依赖关系
  - **交叉注意力层**: 计算两图像特征之间的匹配关系
  - **匹配头**: 生成最终的匹配点对

```
特征图1 → 特征投影 → 自注意力增强 → 
                              → 交叉注意力匹配 → 匹配矩阵 → 匹配点对
特征图2 → 特征投影 → 自注意力增强 →
```

### 1.3 有效点判别模块

- **架构**: 轻量级卷积神经网络
- **输入**: 匹配点周围的局部特征块
- **输出**: 匹配点的置信度得分 (0~1)
- **结构**:
  - 4层卷积网络，每层包含3×3卷积+BatchNorm+ReLU
  - 通道数: 64→128→64→32
  - 全局平均池化层
  - 一个输出单元的全连接层+Sigmoid激活函数

```
局部特征块 → Conv+BN+ReLU(×4) → 全局平均池化 → FC → Sigmoid → 置信度得分
```

### 1.4 连续性约束模块

- **功能**: 确保变形场的平滑性
- **输入**: 特征图和匹配点
- **输出**: 连续性损失值
- **操作**:
  - 计算特征图的梯度
  - 计算匹配点对应区域的梯度一致性
  - 仅在有效点区域应用约束

```
特征图 → 梯度计算 → 梯度一致性度量 → 连续性约束
```

### 1.5 变形估计模块

#### 1.5.1 全局单应性估计

- **架构**: 回归网络
- **输入**: 特征图和匹配矩阵
- **输出**: 8参数单应性矩阵
- **结构**:
  - 特征聚合层
  - 3层全连接网络 (1024→512→256→8)
  - 参数归一化层

#### 1.5.2 局部网格变形

- **架构**: 基于TPS的网格变形
- **输入**: 匹配点对和单应性矩阵
- **输出**: 完整的变形场
- **处理流程**:
  - 基于单应性变换的初始变形
  - 16×16网格点的TPS变形
  - 变形场平滑与归一化

```
匹配点对 → 单应性估计 → 
                    → 合并变形 → 变形场
匹配点对 → TPS变形估计 →
```

## 2. Composition阶段网络结构

Composition阶段负责将几何对齐后的图像进行无缝融合，核心是改进的扩散模型。

### 2.1 ImprovedDiffusionComposition总体架构

- **输入**: 两张变形图像(warp1, warp2)和对应的掩码(mask1, mask2)
- **输出**: 学习到的融合掩码和融合图像
- **参数**:
  - 图像通道数: 3
  - 嵌入维度: 128
  - 扩散步数: 1000
  - 噪声方差范围: β_start=1e-4, β_end=0.02

```
(warp1, warp2, mask1, mask2) → ImprovedDiffusionComposition → (learned_mask, fused_image)
```

### 2.2 主要组件

#### 2.2.1 SinusoidalPositionEmbeddings

- **功能**: 时间步编码
- **输入**: 时间步 t (标量)
- **输出**: d维向量时间编码
- **公式**: 使用正弦和余弦函数生成不同频率的时间编码

```
t → SinusoidalPositionEmbeddings → d维向量
```

#### 2.2.2 AdaptiveNorm

- **功能**: 自适应归一化
- **输入**: 特征x和时间嵌入emb
- **输出**: 归一化后的特征
- **操作**:
  - 基于时间嵌入预测缩放和偏移参数γ(emb)和β(emb)
  - 应用归一化: γ(emb) * (x - μ(x))/σ(x) + β(emb)

```
特征x + 时间嵌入emb → AdaptiveNorm → 归一化特征
```

#### 2.2.3 AttentionBlock

- **功能**: 自注意力机制
- **输入**: 特征图
- **输出**: 注意力增强的特征图
- **结构**:
  - 多头自注意力 (8头)
  - 残差连接
  - LayerNorm正则化

```
特征 → LayerNorm → 多头自注意力 → 残差连接 → 增强特征
```

#### 2.2.4 ImprovedDownBlock

- **功能**: 增强的下采样块
- **输入**: 特征x和时间嵌入emb
- **输出**: 下采样后的特征
- **结构**:
  - 两个残差块，每个包含:
    - AdaptiveNorm + SiLU激活 + 3×3卷积
    - AdaptiveNorm + SiLU激活 + 3×3卷积
    - 残差连接
  - 条件是否使用注意力机制
  - 2×2平均池化实现下采样

```
输入 → ResBlock → (可选)AttentionBlock → ResBlock → 下采样 → 输出
```

#### 2.2.5 ImprovedUpBlock

- **功能**: 增强的上采样块
- **输入**: 当前特征x1, 跳跃连接特征x2, 时间嵌入emb
- **输出**: 上采样后的特征
- **结构**:
  - 转置卷积上采样层
  - 特征连接层，将上采样特征与跳跃连接特征融合
  - 两个残差块
  - 条件是否使用注意力机制

```
x1 → 上采样 → 连接[x1上采样, x2] → ResBlock → (可选)AttentionBlock → ResBlock → 输出
```

#### 2.2.6 FeatureFusion

- **功能**: 特征融合模块
- **输入**: 两组特征F1和F2
- **输出**: 融合后的特征
- **操作**:
  - 特征连接: Concat(F1, F2)
  - 1×1卷积降维
  - 使用分组卷积提高效率

```
特征F1 + 特征F2 → 连接 → 1×1卷积 → 融合特征
```

### 2.3 U-Net整体结构

- **输入**: 6通道图像(连接的img1和img2)，通过通道适配器转为3通道
- **处理流程**:
  1. **初始投影**: 3×3卷积将输入映射到嵌入维度(128通道)
  2. **下采样路径**:
     - 4个ImprovedDownBlock，通道数依次为: 128→256→512→1024
     - 分辨率逐步下降: H×W → H/2×W/2 → H/4×W/4 → H/8×W/8 → H/16×W/16
  3. **中间块**:
     - ResBlock + AttentionBlock + ResBlock
  4. **上采样路径**:
     - 4个ImprovedUpBlock，通道数依次为: 1024→512→256→128
     - 与下采样路径的对应层有跳跃连接
     - 分辨率逐步上升: H/16×W/16 → H/8×W/8 → H/4×W/4 → H/2×W/2 → H×W
  5. **输出投影**: 3×3卷积将128通道映射回3通道

```
3通道输入 → 初始投影(128) → 
  ↓         ↑(跳跃连接)
DownBlock1(256) → UpBlock4(128)
  ↓         ↑(跳跃连接)
DownBlock2(512) → UpBlock3(256)
  ↓         ↑(跳跃连接)
DownBlock3(1024) → UpBlock2(512)
  ↓         ↑(跳跃连接)
DownBlock4(1024) → 中间块(1024) → UpBlock1(1024)
                                    ↓
                                输出投影(3) → 3通道输出
```

### 2.4 通道适配器

- **功能**: 将6通道输入转换为模型期望的3通道输入
- **架构**: 1×1卷积层
- **输入**: 连接的两张图像(6通道)
- **输出**: 适配后的3通道特征

```
6通道输入 → 1×1卷积 → 3通道输出
```

### 2.5 掩码生成网络

- **功能**: 学习融合掩码
- **架构**: 轻量级U-Net
- **输入**: 处理后的特征
- **输出**: 单通道掩码
- **结构**:
  - 4层下采样: 3×3卷积+ReLU+平均池化
  - 特征通道数: 64→128→256→512
  - 4层上采样: 转置卷积+ReLU
  - 跳跃连接
  - 输出层: 1×1卷积+Sigmoid

```
输入特征 → 轻量级U-Net → Sigmoid → 融合掩码
```

## 3. 完整系统流程

```
输入图像对 → Warp阶段(几何对齐) → 变形图像和掩码 → Composition阶段(图像融合) → 最终融合图像
```

## 4. 关键创新点

1. **有效点判别机制**: 自动识别和过滤不可靠的匹配点
2. **连续性约束**: 确保匹配点的空间连续性
3. **改进的扩散模型**: 结合多尺度特征融合和自适应归一化
4. **通道适配器**: 灵活处理不同通道数的输入
5. **时间编码增强**: 更精确的扩散过程控制
6. **多层次损失函数**: 边界、平滑、感知、多尺度和扩散损失的组合 